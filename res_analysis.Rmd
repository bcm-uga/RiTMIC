---
title: "Distances"
author: "Clémentine Decamps"
date: "12 Février 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ptlmapper")
library("ggplot2")

```

#Data


On a deux types de données pour chaque cancer :

* Penda : matrice de taille n*g, avec pour chaque gène g son statut de dérégulation dans les patients n : 0, 1 ou -1

* cell : matrice de proportion k*n avec pour chaque patient n la proportion des différents types cellulaires k

On trie les matrices pour avoir les patients en commun, et seulement les gènes avec plus de 100 patients dérégulés ou non dérégulés.

```{r data, echo = TRUE}
T_ctrl = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_rna.rds")
T_60tum_c = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_c.rds")
T_60tum_s = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_s.rds")
A_60p = readRDS("~/projects/pipeline_deconv_analysis/data/A/A_60.rds")

genes_c = c(rownames(T_60tum_c$T)[T_60tum_c$g_immune], rownames(T_60tum_c$T)[T_60tum_c$g_fibro])

genes_s = c(rownames(T_60tum_s$T)[T_60tum_s$g_immune], rownames(T_60tum_s$T)[T_60tum_s$g_fibro])

penda_res_c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/test_simu1c.rds")
penda_res_s = readRDS("~/projects/pipeline_deconv_analysis/results/penda/test_simu1s.rds")
penda_ssdereg = readRDS("~/projects/pipeline_deconv_analysis/results/penda/test_sansdereg.rds")
penda_res_60s_ctrlres = readRDS("~/projects/pipeline_deconv_analysis/results/penda/test_penda_s_ctrlres.rds")
penda_res_60c_ctrlres = readRDS("~/projects/pipeline_deconv_analysis/results/penda/test_penda_c_ctrlres.rds")



penda_cond_s = abs(penda_res_s$up_genes - penda_res_s$down_genes)
penda_cond_c = abs(penda_res_c$up_genes - penda_res_c$down_genes)
penda_cond_na = abs(penda_ssdereg$up_genes - penda_ssdereg$down_genes)

penda_cond_s_ctrlres = abs(penda_res_60s_ctrlres$up_genes - penda_res_60s_ctrlres$down_genes)
penda_cond_c_ctrlres = abs(penda_res_60c_ctrlres$up_genes - penda_res_60c_ctrlres$down_genes)

table(penda_cond_s == penda_cond_na)
table(penda_cond_c == penda_cond_na)

g_egaux = which(apply(penda_cond_s, 1, function(g) {
  length(table(g)) == 1
}))
penda_cond_s = penda_cond_s[-g_egaux, ]

g_egaux = which(apply(penda_cond_c, 1, function(g) {
  length(table(g)) == 1
}))
penda_cond_c = penda_cond_c[-g_egaux, ]

g_egaux = which(apply(penda_cond_na, 1, function(g) {
  length(table(g)) == 1
}))
penda_cond_na = penda_cond_na[-g_egaux, ]

g_egaux = which(apply(penda_cond_s_ctrlres, 1, function(g) {
  length(table(g)) == 1
}))
penda_cond_s_ctrlres = penda_cond_s_ctrlres[-g_egaux, ]

g_egaux = which(apply(penda_cond_c_ctrlres, 1, function(g) {
  length(table(g)) == 1
}))
penda_cond_c_ctrlres = penda_cond_c_ctrlres[-g_egaux, ]


g_sup = which(apply(penda_cond_s, 1, function(g) {
  table(g)[1] > 5 & table(g)[2] > 5
}))
penda_cond_s = penda_cond_s[g_sup, ]

g_sup = which(apply(penda_cond_c, 1, function(g) {
  table(g)[1] > 5 & table(g)[2] > 5
}))
penda_cond_c = penda_cond_c[g_sup, ]

g_sup = which(apply(penda_cond_na, 1, function(g) {
  table(g)[1] > 5 & table(g)[2] > 5
}))
penda_cond_na = penda_cond_na[g_sup, ]

g_sup = which(apply(penda_cond_s_ctrlres, 1, function(g) {
  table(g)[1] > 5 & table(g)[2] > 5
}))
penda_cond_s_ctrlres = penda_cond_s_ctrlres[g_sup, ]

g_sup = which(apply(penda_cond_c_ctrlres, 1, function(g) {
  table(g)[1] > 5 & table(g)[2] > 5
}))
penda_cond_c_ctrlres = penda_cond_c_ctrlres[g_sup, ]

dim(penda_cond_s)
dim(penda_cond_c)
dim(penda_cond_na)

table(genes_s %in% rownames(penda_cond_s))
table(genes_c %in% rownames(penda_cond_c ))

genes_s_f = genes_s[(genes_s %in% rownames(penda_cond_s))]
genes_c_f = genes_c[(genes_c %in% rownames(penda_cond_c ))]

genes_s_fb = genes_s[(genes_s %in% rownames(penda_cond_s_ctrlres))]
genes_c_fb = genes_c[(genes_c %in% rownames(penda_cond_c_ctrlres))]
```


#Test par type cellulaire 

##Calculs

### P valeurs et distances

On étudie la distance entre deux groupes, qui contiennent les gènes dérégulés VS les gènes inchangés, dans 100 individus chacun minimum.

On passe chaque gène de Penda un par un. Pour chaque type cellulaire, on calcule la distance des deux groupes. On obtient pour chacun des trois paramètres une matrice de distances de taille g*k avec pour chaque gène et pour chaque type cellulaire les valeurs : 

* Distance de kantorovich
* -log10(p-valeur) du test de Student
* Distance et -log10(p-valeur) du test de Kolmogorov-Smirnov
* cv de chaque groupe


```{r simu_s, echo = FALSE }
options(warn = -1)
res_dereg_s = c()

#Pour chaque gène
for(g in rownames(penda_cond_s)){
  gene = penda_cond_s[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  if(length(p_dereg) != 0 & length(p_zero) != 0){
  #Pour chaque type cellulaire
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    x = A_60p[t, p_dereg]
    y = A_60p[t, p_zero]
    
    kanto_dist = kantorovich(x, y)
    student = -log10(t.test(x, y)$p.value)
    ks = ks.test(x, y)
    cvx = sd(x) / mean(x)
    cvy = sd(y) / mean(y)
      
    res_dereg_s = rbind(res_dereg_s, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
    }
  }
}

colnames(res_dereg_s) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
options(warn = 0)

print("Dim des matrices de résultat")
dim(res_dereg_s)
```

```{r simu_c, echo = FALSE }

options(warn = -1)
res_dereg_c = c()

#Pour chaque gène
for(g in rownames(penda_cond_c)){
  gene = penda_cond_c[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  #Pour chaque type cellulaire
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    x = A_60p[t, p_dereg]
    y = A_60p[t, p_zero]
    
    kanto_dist = kantorovich(x, y)
    student = -log10(t.test(x, y)$p.value)
    ks = ks.test(x, y)
    cvx = sd(x) / mean(x)
    cvy = sd(y) / mean(y)
      
    res_dereg_c = rbind(res_dereg_c, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
  }
}

colnames(res_dereg_c) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
options(warn = 0)

print("Dim des matrices de résultat")
dim(res_dereg_c)
```

```{r penda_na, echo = FALSE }
options(warn = -1)
res_dereg_na = c()

#Pour chaque gène
for(g in rownames(penda_cond_na)){
  gene = penda_cond_na[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  #Pour chaque type cellulaire
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    x = A_60p[t, p_dereg]
    y = A_60p[t, p_zero]
    
    kanto_dist = kantorovich(x, y)
    student = -log10(t.test(x, y)$p.value)
    ks = ks.test(x, y)
    cvx = sd(x) / mean(x)
    cvy = sd(y) / mean(y)
      
    res_dereg_na = rbind(res_dereg_na, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
  }
}

colnames(res_dereg_na) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
options(warn = 0)

print("Dim des matrices de résultat")
dim(res_dereg_na)
```

```{r sur res, echo = FALSE }

options(warn = -1)
res_dereg_s_ctrlres = c()

#Pour chaque gène
for(g in rownames(penda_cond_s_ctrlres)){
  gene = penda_cond_s_ctrlres[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  if(length(p_dereg) != 0 & length(p_zero) != 0){
  #Pour chaque type cellulaire
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    x = A_60p[t, p_dereg]
    y = A_60p[t, p_zero]
    
    kanto_dist = kantorovich(x, y)
    student = -log10(t.test(x, y)$p.value)
    ks = ks.test(x, y)
    cvx = sd(x) / mean(x)
    cvy = sd(y) / mean(y)
      
    res_dereg_s_ctrlres = rbind(res_dereg_s_ctrlres, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
    }
  }
}

colnames(res_dereg_s_ctrlres) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
options(warn = 0)

print("Dim des matrices de résultat")
dim(res_dereg_s_ctrlres)

options(warn = -1)
res_dereg_c_ctrlres = c()

#Pour chaque gène
for(g in rownames(penda_cond_c_ctrlres)){
  gene = penda_cond_c_ctrlres[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  #Pour chaque type cellulaire
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    x = A_60p[t, p_dereg]
    y = A_60p[t, p_zero]
    
    kanto_dist = kantorovich(x, y)
    student = -log10(t.test(x, y)$p.value)
    ks = ks.test(x, y)
    cvx = sd(x) / mean(x)
    cvy = sd(y) / mean(y)
      
    res_dereg_c_ctrlres = rbind(res_dereg_c_ctrlres, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
  }
}

colnames(res_dereg_c_ctrlres) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
options(warn = 0)

print("Dim des matrices de résultat")
dim(res_dereg_c_ctrlres)


```

###Corrélation avec l'expression

```{r, echo = FALSE }
cor_T60_c = c()
cor_T60_s = c()
options(warn = -1)
for(g in rownames(T_60tum_s$T)){
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    c = cor(T_60tum_c$T[g, ], A_60p[t, ])
    cor_T60_c = rbind(cor_T60_c, c(g, t, c))
    c = cor(T_60tum_s$T[g, ], A_60p[t, ])
    cor_T60_s = rbind(cor_T60_s, c(g, t, c))
  }
}
options(warn = 0)


```

##Représentation

Si on représente graphiquement ces matrices, on voit nettement les gènes qui donnent une plus grande distance entre les deux groupes pour chaque type : ces gènes doivent donc être propre au type cellulaire.

Si pour un gène et un type cellulaire il y a une grande distance entre le groupe qui ne l'exprime pas et le groupe qui le surexprime, ça signifie que ce gène est probablement un marqueur de ce type cellulaire.

Kanto : 75% des distances < 0.059

Student : 75% des -log10(pvalue) < 0.59

Ks : 75% des -log10(pvalue) < 0.56

```{r plot_deregul, echo = F}
df_s = data.frame(genes = res_dereg_s[, 1],
                kanto = as.numeric(res_dereg_s[, 5]),
                type =  factor(res_dereg_s[, 4]),
                student = as.numeric(res_dereg_s[, 6]),
                ks = as.numeric(res_dereg_s[, 8]),  stringsAsFactors = F)

df_c = data.frame(genes = res_dereg_c[, 1],
                kanto = as.numeric(res_dereg_c[, 5]),
                type =  factor(res_dereg_c[, 4]),
                student = as.numeric(res_dereg_c[, 6]),
                ks = as.numeric(res_dereg_c[, 8]),  stringsAsFactors = F)

df_na = data.frame(genes = res_dereg_na[, 1],
                kanto = as.numeric(res_dereg_na[, 5]),
                type =  factor(res_dereg_na[, 4]),
                student = as.numeric(res_dereg_na[, 6]),
                ks = as.numeric(res_dereg_na[, 8]),  stringsAsFactors = F)

df_s_ctrlres = data.frame(genes = res_dereg_s_ctrlres[, 1],
                kanto = as.numeric(res_dereg_s_ctrlres[, 5]),
                type =  factor(res_dereg_s_ctrlres[, 4]),
                student = as.numeric(res_dereg_s_ctrlres[, 6]),
                ks = as.numeric(res_dereg_s_ctrlres[, 8]),  stringsAsFactors = F)

df_c_ctrlres = data.frame(genes = res_dereg_c_ctrlres[, 1],
                kanto = as.numeric(res_dereg_c_ctrlres[, 5]),
                type =  factor(res_dereg_c_ctrlres[, 4]),
                student = as.numeric(res_dereg_c_ctrlres[, 6]),
                ks = as.numeric(res_dereg_c_ctrlres[, 8]),  stringsAsFactors = F)
```

```{r, echo = F}
summary(df_s$kanto)
summary(df_c$kanto)

summary(df_s$student)
summary(df_c$student)

summary(df_s$ks)
summary(df_c$ks)

g_fibro = genes_s_f[genes_s_f%in%rownames(T_60tum_s$T)[T_60tum_s$g_fibro]] 
df_s[df_s$genes %in% g_fibro & df_s$type == 2 , ]

g_immune = genes_s_f[genes_s_f%in%rownames(T_60tum_s$T)[T_60tum_s$g_immune]] 
df_s[df_s$genes %in% g_immune & df_s$type == 3 , ]

g_fibro = genes_c_f[genes_c_f%in%rownames(T_60tum_c$T)[T_60tum_c$g_fibro]] 
df_c[df_c$genes %in% g_fibro & df_c$type == 2 , ]

g_immune = genes_c_f[genes_c_f%in%rownames(T_60tum_c$T)[T_60tum_c$g_immune]] 
df_c[df_c$genes %in% g_immune & df_c$type == 3 , ]

```

###P-valeurs et courbes ROC

#### Simu s et c

```{r, echo = F}
compute_1_res = function(values, genes, genes_fibro, genes_immune, pval){
  names(values) = stringr::str_c(genes, rep(1:4))
  
  genes_dereg = c(values[stringr::str_c(genes_fibro, rep(2))], values[stringr::str_c(genes_immune, rep(3))])
  
  values = values[!is.na(values)]
  
  TP = sum(genes_dereg > -log10(pval))
  
  FN = length(genes_dereg) - TP
  
  FP =  sum(values > -log10(pval)) - TP
  
  TN =  length(values) - TP - FN - FP
  
  TPR  = TP / (TP + FN)
  FPR = FP / (TN + FP)
  return(c(TP, FP, TN, FN, FPR, TPR))
}

pvalues = c(0, 0.00005, 0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.15, 0.2, 0.25,  0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)

g_fibro = unique(genes_s_f[genes_s_f%in%rownames(T_60tum_s$T)[T_60tum_s$g_fibro]])
g_immune = unique(genes_s_f[genes_s_f%in%rownames(T_60tum_s$T)[T_60tum_s$g_immune]] )
res_ks = sapply(pvalues, function(x){compute_1_res(df_s$ks, df_s$genes, g_fibro, g_immune, x)})

res_st = sapply(pvalues, function(x){compute_1_res(df_s$student, df_s$genes, g_fibro, g_immune, x)})

res_kanto = sapply(pvalues, function(x){compute_1_res(df_s$kanto, df_s$genes, g_fibro, g_immune, x)})

res_cor = sapply(pvalues, function(x){compute_1_res(abs(as.numeric(cor_T60_s[, 3])), cor_T60_s[, 1], rownames(T_60tum_s$T)[T_60tum_s$g_fibro], rownames(T_60tum_s$T)[T_60tum_s$g_immune], x)})

df = data.frame(pval = as.factor(rep(pvalues)),
                FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                metrique = rep(c("ks", "student", "kanto", "correlation"), each = length(pvalues)))

plot_s = ggplot(df, aes(x = FPR, y = TPR, color = metrique, group = metrique)) +
  geom_point() + 
  geom_line() + 
  theme_minimal()+
  labs(title = "Simu s") 

plot_s



g_fibro = unique(genes_c_f[genes_c_f%in%rownames(T_60tum_c$T)[T_60tum_c$g_fibro]])
g_immune = unique(genes_c_f[genes_c_f%in%rownames(T_60tum_c$T)[T_60tum_c$g_immune]] )
res_ks = sapply(pvalues, function(x){compute_1_res(df_c$ks, df_c$genes, g_fibro, g_immune, x)})
res_st = sapply(pvalues, function(x){compute_1_res(df_c$student, df_c$genes, g_fibro, g_immune, x)})
res_kanto = sapply(pvalues, function(x){compute_1_res(df_c$kanto, df_c$genes, g_fibro, g_immune, x)})
res_cor = sapply(pvalues, function(x){compute_1_res(abs(as.numeric(cor_T60_c[, 3])), cor_T60_c[, 1], rownames(T_60tum_c$T)[T_60tum_c$g_fibro], rownames(T_60tum_c$T)[T_60tum_c$g_immune], x)})

df = data.frame(pval = as.factor(rep(pvalues)),
                FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                metrique = rep(c("ks", "student", "kanto", "correlation"), each = length(pvalues)))

plot_c = ggplot(df, aes(x = FPR, y = TPR, color = metrique, group = metrique)) +
  geom_point() + 
  geom_line() + 
  theme_minimal()+
  labs(title = "Simu c") 

plot_c



res_na = sapply(pvalues, function(x){sum(df_na$ks > -log10(x))})
pvalues
res_na 
res_na = sapply(pvalues, function(x){sum(df_na$student > -log10(x))})
pvalues
res_na 


```

####T tum ref VS epi déconvolué
```{r, echo = F}
pvalues = c(0, 0.00005, 0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.15, 0.2, 0.25,  0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)

g_fibro = unique(genes_s_fb[genes_s_fb%in%rownames(T_60tum_s$T)[T_60tum_s$g_fibro]])
g_immune = unique(genes_s_fb[genes_s_fb%in%rownames(T_60tum_s$T)[T_60tum_s$g_immune]] )

res_ks = sapply(pvalues, function(x){compute_1_res(df_s_ctrlres$ks, df_s_ctrlres$genes, g_fibro, g_immune, x)})
res_st = sapply(pvalues, function(x){compute_1_res(df_s_ctrlres$student, df_s_ctrlres$genes, g_fibro, g_immune, x)})
res_kanto = sapply(pvalues, function(x){compute_1_res(df_s_ctrlres$kanto, df_s_ctrlres$genes, g_fibro, g_immune, x)})
res_cor = sapply(pvalues, function(x){compute_1_res(abs(as.numeric(cor_T60_s[, 3])), cor_T60_s[, 1], rownames(T_60tum_s$T)[T_60tum_s$g_fibro], rownames(T_60tum_s$T)[T_60tum_s$g_immune], x)})

df = data.frame(pval = as.factor(rep(pvalues)),
                FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                metrique = rep(c("ks", "student", "kanto", "correlation"), each = length(pvalues)))

plot_ref_s = ggplot(df, aes(x = FPR, y = TPR, color = metrique, group = metrique)) +
  geom_point() + 
  geom_line() + 
  theme_minimal()+
  labs(title = "T tum s sur T epi calculée") 

plot_ref_s


g_fibro = unique(genes_c_fb[genes_c_fb%in%rownames(T_60tum_c$T)[T_60tum_c$g_fibro]])
g_immune = unique(genes_c_fb[genes_c_fb%in%rownames(T_60tum_c$T)[T_60tum_c$g_immune]] )

res_ks = sapply(pvalues, function(x){compute_1_res(df_c_ctrlres$ks, df_c_ctrlres$genes, g_fibro, g_immune, x)})
res_st = sapply(pvalues, function(x){compute_1_res(df_c_ctrlres$student, df_c_ctrlres$genes, g_fibro, g_immune, x)})
res_kanto = sapply(pvalues, function(x){compute_1_res(df_c_ctrlres$kanto, df_c_ctrlres$genes, g_fibro, g_immune, x)})
res_cor = sapply(pvalues, function(x){compute_1_res(abs(as.numeric(cor_T60_c[, 3])), cor_T60_c[, 1], rownames(T_60tum_c$T)[T_60tum_c$g_fibro], rownames(T_60tum_c$T)[T_60tum_c$g_immune], x)})

df = data.frame(pval = as.factor(rep(pvalues)),
                FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                metrique = rep(c("ks", "student", "kanto", "correlation"), each = length(pvalues)))

plot_ref_c = ggplot(df, aes(x = FPR, y = TPR, color = metrique, group = metrique)) +
  geom_point() + 
  geom_line() + 
  theme_minimal()+
  labs(title = "T tum c sur T epi calculée") 

plot_ref_c
```

