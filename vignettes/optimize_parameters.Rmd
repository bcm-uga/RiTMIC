---
title: "optimize_parameter"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
# matrice D, , calculée pour T deconv et A deconv (= data case)
D_2v2_c <- readRDS("~/Datas/projects/data/extdata/D_2v2_c.rds")
dim(D_2v2_c)

# matrice T, T deconv, il faut prendre la colonne 1 pour avoir le type épi qui sert de data ctrl Penda
EDec2_80p_c_t <- readRDS("~/Datas/projects/data/extdata/EDec2_80p_c_t.rds")
dim(EDec2_80p_c_t)
matrice_T_control <- EDec2_80p_c_t[,1]
length(matrice_T_control)

# matrice T après déconv [,1] = Epithelium: matrice contrôle de penda
T_tum_ref <- readRDS("~/Datas/projects/data/extdata/T_60_tum_rna_c_t.rds")
dim(T_tum_ref$T)

# matrice T tumeur de référence, composée de $T, $g_immune et $g_fibro, sert pour la vignette analyse_deconv
T_60tum_c <- readRDS("~/Datas/projects/data/extdata/T_60_tum_rna_c_t.rds")
dim(T_60tum_c$T)

# matrice A de référence 
A_60p <- readRDS("~/Datas/projects/data/extdata/A_60.rds")
dim(A_60p)

# Matrice A après déconvolution
EDec_80p <- readRDS("~/Datas/projects/data/extdata/EDec_80p.rds")
EDec_80p_a <- EDec_80p$A[,1:60]
dim(EDec_80p_a)
dim(EDec_80p$T)
```

```{r,echo=FALSE}
Penda_dataset = penda::make_dataset_1ctrl(control = matrice_T_control, data_case = D_2v2_c)
data_ctrl = Penda_dataset$data_ctrl
data_case = Penda_dataset$data_case

s_max = 500
L_H_list = penda::compute_lower_and_higher_lists_1ctrl(data_ctrl, s_max = s_max)
L = L_H_list$L
H = L_H_list$H

list1 <- (0:7)/10
list2 <- (80:100)/100
listf <- c(list1,list2)
iterations =  20
dir.create("~/Datas/projects/data/optimize_parameters",recursive = TRUE)
for (threshold in listf){
  penda_res = penda::penda_test_1ctrl(samples = data_case, 
                   iterations =  iterations, 
                   L_H_list =  L_H_list, 
                   threshold = threshold)
  saveRDS(penda_res,file = paste('~/Datas/projects/data/optimize_parameters/res_', threshold, '.RDS',sep=""))
}
res01 <- readRDS("~/Datas/projects/data/optimize_parameters/res_0.1.RDS")
res08 <- readRDS("~/Datas/projects/data/optimize_parameters/res_0.8.RDS")
res096 <- readRDS("~/Datas/projects/data/optimize_parameters/res_0.96.RDS")

total_matrix <- dim(res01$down_genes)[1]*dim(res01$down_genes)[2]
all.equal(res01$down_genes, res08$down_genes)
all.equal(res08$down_genes, res096$down_genes)

```


```{r,echo=TRUE}
# Test all samples
EDec_80p <- readRDS("~/Datas/projects/data/extdata/EDec_80p.rds")
EDec_80p_a <- EDec_80p$A[,1:60]

calc_corr_output <- readRDS('~/Datas/projects/data/optimize_parameters/pre_plot.RDS')
T <- calc_corr_output$matrix_T
cor_T <- readRDS('~/Datas/projects/data/optimize_parameters/cor_T60_c.RDS')
pvalues <- c(0, 0.00005, 0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.15, 0.2, 0.25,  0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)
genes = c(rownames(T$T)[T$g_immune], rownames(T$T)[T$g_fibro])

list1 <- (1:7)/10
list2 <- (80:100)/100
listf <- c(list1,list2)
listf
for (threshold in listf){
  penda_res <- readRDS(paste('~/Datas/projects/data/optimize_parameters/res_',threshold,'.RDS',sep=""))
  pre_treat_res <- RiTMIC::pre_treat(penda_res = penda_res, patientNumber=5)
  calc_dist_output <- RiTMIC ::calc_dist(pre_treat_output = pre_treat_res, matrix_A = A_60p)
  genes_f <- calc_dist_output$genes
  df <- calc_dist_output$df
  g_fibro = unique(genes_f[genes_f%in%rownames(T$T)[T$g_fibro]])
  g_immune = unique(genes_f[genes_f%in%rownames(T$T)[T$g_immune]])

  res_ks = sapply(pvalues, function(x){
    compute_1_res(df$ks, df$genes, g_fibro, g_immune, x)
  })
  res_st = sapply(pvalues, function(x){
    compute_1_res(df$student, df$genes, g_fibro, g_immune, x)
  })
  res_kanto = sapply(pvalues, function(x){
    compute_1_res(df$kanto, df$genes, g_fibro, g_immune, x)
  })
  res_cor = sapply(pvalues, function(x){
    compute_1_res(abs(as.numeric(cor_T[, 3])), cor_T[, 1], rownames(T$T)[T$g_fibro], rownames(T$T)[T$g_immune], x)})
  # Initialization
  dfTemp = data.frame(pval = as.factor(rep(pvalues)),
                  FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                  TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                  metrique = rep(c("ks", "student", "kanto", "correlation"),each = length(pvalues)))
  saveRDS(dfTemp, file = paste("~/Datas/projects/data/optimize_parameters/df_",threshold,'.RDS',sep=""))
}
```

```{r,echo=TRUE}
list1 <- (1:7)/10
list2 <- (80:100)/100
listf <- c(list1,list2)
#Data loading
for (threshold in listf){
  assign('df', readRDS(paste('~/Datas/projects/data/optimize_parameters/df_',threshold,'.RDS',sep="")))
  assign(paste('df_',threshold,sep=''), readRDS(paste('~/Datas/projects/data/optimize_parameters/df_',threshold,'.RDS',sep="")))
}
cor <- readRDS('~/Datas/projects/data/optimize_parameters/cor_T60_c.RDS')

df <- data.frame(df_0.1,"threshold"=0.1)

list2 <- listf[2:28]
for (threshold in list2){
  assign('tempDF',eval(parse(text = paste('df_',threshold,sep=""))))
  tempDF['threshold'] <- threshold
  df <- rbind(df,tempDF)
}
dim(df)
dim(cor)
length(df$pval[df$metrique == "correlation"])
```

```{r}
df_kanto <- subset(df,df$metrique == "kanto")
df_kanto$threshold = as.factor(df_kanto$threshold)
corr <- subset(df,(df$metrique=="correlation" & df$threshold==0.1))
corr$threshold <- "correlation"
df_kanto <- rbind(df_kanto,corr)

plot_kanto <- ggplot(df_kanto, aes(x = FPR, y = TPR, color = threshold, group = threshold)) + 
  geom_point()+
  geom_line()+
  theme_minimal()+
  labs(title="Kantorovich")

plot_kanto

```

```{r}
df_student <- subset(df,df$metrique == "student")
df_student$threshold = as.factor(df_student$threshold)
df_student <- rbind(df_student,corr)

plot_student <- ggplot(df_student, aes(x = FPR, y = TPR, color = threshold, group = threshold)) + 
  geom_point()+
  geom_line()+
  theme_minimal()+
  labs(title="Student")

plot_student
```

```{r}
df_ks <- subset(df,df$metrique == "ks")
df_ks$threshold = as.factor(df_ks$threshold)
df_ks <- rbind(df_ks,corr)

plot_ks <- ggplot(df_ks, aes(x = FPR, y = TPR, color = threshold, group = threshold)) + 
  geom_point()+
  geom_line()+
  theme_minimal()+
  labs(title="Kolmogorov Smirnov")

plot_ks
```

```{r, label="Last modif"}

library(progress)
options(warn = -1)
cor_T60_c = c()
pb <- progress_bar$new(format = "  Running RiTMIC::pre_plot_res [:bar] :current/:total (:percent) in :elapsed",total = (nrow(D_2v2_c)*nrow(EDec_80p_a/2)), clear = FALSE, width= 80)
for(g in 1:nrow(D_2v2_c)){
  pb$tick()
  for(t in 1:nrow(EDec_80p_a)){
    res <- try(capture.output(c = cor(D_2v2_c[g, ], EDec_80p_a[t, ])), silent = T)
    cor_T60_c = rbind(cor_T60_c, c(g, t, c))
  }
}
options(warn = 0)
saveRDS(cor_T60_c,file = '~/Datas/projects/data/optimize_parameters/cor_T60_c.RDS')
EDec_80p <- readRDS("~/Datas/projects/data/extdata/EDec_80p.rds")
EDec_80p_a <- EDec_80p$A[,1:60]

calc_corr_output <- readRDS('~/Datas/projects/data/optimize_parameters/pre_plot.RDS')
T <- calc_corr_output$matrix_T
matrix_D <- list(list(matrix_D = D_2v2_c,T_cancer = T_tum_ref, T = cor_T60_c))
cor_T <- list(cor_T = cor_T60_c, matrix_D = matrix_D)
pvalues <- c(0, 0.00005, 0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.15, 0.2, 0.25,  0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)
genes = c(rownames(T$T)[T$g_immune], rownames(T$T)[T$g_fibro])

list1 <- (1:7)/10
list2 <- (80:100)/100
listf <- c(list1,list2)
listf
dfTempf = data.frame(pval=c(),FPR=c(),TPR=c(),metrique=c())
for (threshold in listf){
  penda_res <- readRDS(paste('~/Datas/projects/data/optimize_parameters/res_',threshold,'.RDS',sep=""))
  pre_treat_res <- RiTMIC::pre_treat(penda_res = penda_res, patientNumber=5)
  calc_dist_output <- RiTMIC ::calc_dist(pre_treat_output = pre_treat_res, matrix_A = A_60p)
  genes_f <- calc_dist_output$genes
  df <- calc_dist_output$df
  g_fibro = unique(genes_f[genes_f%in%rownames(T$T)[T$g_fibro]])
  g_immune = unique(genes_f[genes_f%in%rownames(T$T)[T$g_immune]])
  res_cor = sapply(pvalues, function(x){
  compute_1_res(abs(as.numeric(cor_T[, 3])), cor_T[, 1], rownames(T$T)[T$g_fibro], rownames(T$T)[T$g_immune], x)})
  
  dfTemp = data.frame(pval = as.factor(rep(pvalues)),
                  FPR = res_cor[5, ],
                  TPR = res_cor[6, ],
                  metrique = correlation, each = length(pvalues))
  dfTempf <- rbind(dfTempf,dfTemp)
}
```