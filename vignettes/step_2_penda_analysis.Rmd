---
title: "RiTMIC: RegulatIon of Tumor MIcroenvironment Composition"
subtitle: "Step 2: Analysis with `penda` (performing personalized data analysis)"
author: "Magali Richard, Clementine Decamps, Florent Chuffart, Fabien Quinquis, Daniel Jost"
contact: 
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
vignette: >
  %\VignetteIndexEntry{analysis}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=TRUE, results="verbatim", dpi=75)
layout(1, respect=TRUE)
penda::draw_penda()
```

# Introduction and `penda` presentation

`RiTMIC` (**R**egulat**I**on of **T**umor **MI**croenvironment **C**omposition) is an open-access R package that simulates the necessary tools to perform `PenDA` analysis, perform analysis with `PenDA` and apply visualization tools to the `PenDA` output. 

`RiTMIC` **"Step 2: Analysis with `penda` (Performing personalized data analysis)**

`penda` (**PE**rso**N**alized **D**ifferential **A**nalysis ) is an open-access R package that detects gene deregulation in individual samples compared to a set of reference, control samples. `penda_1ctrl` is an adaptation of this method for a specific case, only one sample as reference. This particular experimental condition causes a loss of power, as long as possible use the classic version of Penda. This tutorial aims at providing to non-expert users basic informations and illustrations on how to run the package.

How to cite: Richard, M. et al. PenDA, a rank-based method for personalized differential analysis: Application to lung cancer. PLOS Computational Biology 16, e1007869 (2020).

# Dataset and data filtering

## Dataset

The dataset: the matrix_D from the \code{simu_D} function is required to perform PenDA analysis. 

Please, check out the `simulation` vignette for more details.  

## Method

`penda` performs a 3-steps analysis: 
  1. Data filtering
  2. Relative gene ordering
  3. Differential expression testing

## Data filtering
```{r echo=FALSE, label="data_loading"}
simu_D_output = readRDS("~/Datas/projects/RiTMIC/inst/extdata/matrix_D.RDS")
matrix_D <- simu_D_output$matrix_D
penda_data_case <- penda::penda_data_case

matrix_D_control <- penda::penda_data_ctrl[,4]

Penda_dataset = penda::make_dataset_1ctrl(matrix_D_control, matrix_D)
data_ctrl = Penda_dataset$data_ctrl
data_case = Penda_dataset$data_case
```

The function `make_dataset_1ctrl` sorts the genes based on the value of gene expression in control. This step is essential for the proper functioning of `penda`.

## Relative gene ordering

```{r, label= "penda::compute_lower_and_higher_lists"}
s_max = 500
L_H_list = penda::compute_lower_and_higher_lists_1ctrl(data_ctrl, s_max = s_max)
L = L_H_list$L
H = L_H_list$H
```

The `penda` method uses the relative gene ordering in normal tissue. 

The function `compute_lower_and_higher_lists_1ctrl` computes two matrices `L` and `H` based on the filtered control dataset (`data_ctrl`).  

Each row of the **L** matrix contains a list of at most `s_max` (default value = `r s_max`) genes (characterized by their ids) whose expressions are **lower** than that of the gene associated to the corresponding row.

Each row of the **H** matrix contains a list of at most `s_max` (default value = `r s_max`) genes (characterized by their ids) whose expressions are **higher** than that of the gene associated to the corresponding row.

Below, we show the number of genes in the L and H lists. 


```{r echo=FALSE, label="Frequence_of_genes_in_ L_or_H_lists_per_gene"}
layout(matrix(1:2, 1), respect=TRUE)
hist(rowSums(L_H_list$L != 0), xlab = "nb of L genes", main = "Size of L list")
hist(rowSums(L_H_list$H != 0), xlab = "nb of H genes", main = "Size of H list")
```


## Differential expression testing

```{r, label="penda::penda_test_1ctrl", results="hide"}
threshold = 0.4
iterations =  20

penda_res = penda::penda_test_1ctrl(samples = data_case, 
                   iterations =  iterations, 
                   L_H_list =  L_H_list, 
                   threshold = threshold)

#Store the penda_res output for the res_statistics vignette
saveRDS(penda_res, file="~/Datas/projects/RiTMIC/inst/extdata/penda_res.RDS")
```

The function  `penda_test_1ctrl` infers for each gene and for each sample of the `data_case` matrix its deregulation status (up-regulation, down-regulation or no deregulation). This function analyses case samples one by one. It is based on the `L_H_list` and tracks for changes in relative ordering in the sample of interest. If these changes exceed the given `threshold`, the gene of interest is considered as deregulated. 

By default, the `threshold` parameter is set to `r threshold` but we strongly advise users to use the vignette `vignette simulation` to adjust this parameter to the user-specific data.

Results are in the form of two matrices `$down_genes` and `$up_genes`. Each row corresponds to a gene and each column to a case sample. A TRUE entry in these matrices means that the corresponding genes are deregulated (down or up-regulated) in the corresponding samples. 

```{r, echo=FALSE}
data_bypatient = RiTMIC::generate_data_bypatient(D_list = penda_res$down_genes,
                                         U_list = penda_res$up_genes)

RiTMIC::plot_figure(data_patients = data_bypatient)
```

```{r fig.width=9, fig.height=9, echo=FALSE}
RiTMIC::plot_heatmap_hclust(data = penda_res)
```


# Material and methods

*This paragraph is automatically generated by the vignette to specify the method and data filtering parameters. It can be directly cut and paste to the "material and methods" section of the user analysis.*

The PenDA vignette of the specific version for one control of the `penda` package version 1.0 was executed on genes, using 1 control sample and case samples. #CF : Initial file 

1 control was used to generate L and H lists using the following parameters: s_max = `r s_max`.

The PenDA method was then applied on `r ncol(data_case)` cases, with the following set of parameters: threshold = `r threshold`.

# Session Information

```{r, results="verbatim"}
sessionInfo()
```
