---
title: "Distances"
author: "Clémentine Decamps"
date: "12 Février 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("ptlmapper")
library("ggplot2")

```

#Data


On a deux types de données pour chaque cancer :

* Penda : matrice de taille n*g, avec pour chaque gène g son statut de dérégulation dans les patients n : 0, 1 ou -1

* cell : matrice de proportion k*n avec pour chaque patient n la proportion des différents types cellulaires k

On trie les matrices pour avoir les patients en commun, et seulement les gènes avec plus de 100 patients dérégulés ou non dérégulés.

```{r data, echo = TRUE}
T_60tum_c = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_c_t.rds")
T_60tum_n = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_n.rds")
A_60p = readRDS("~/projects/pipeline_deconv_analysis/data/A/A_60.rds")
A_60p_deconv = readRDS("~/projects/pipeline_deconv_analysis/results/deconv/EDec_80p.rds")$A[c(1, 2, 4, 3), 1:60]
genes_c = c(rownames(T_60tum_c$T)[T_60tum_c$g_immune], rownames(T_60tum_c$T)[T_60tum_c$g_fibro])
genes_n = c(rownames(T_60tum_n$T)[T_60tum_n$g_immune], rownames(T_60tum_n$T)[T_60tum_n$g_fibro])

penda_res_1v1c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v1_c_t.rds")
penda_res_1v1n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v1_n.rds")
penda_res_1v2c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v2_c_t.rds")
penda_res_1v2n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v2_n.rds")

penda_res_2v1c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v1_c_t.rds")
penda_res_2v1n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v1_n.rds")
penda_res_2v2c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v2_c_t.rds")
penda_res_2v2n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v2_n.rds")

penda_res_3v1c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_3v1_c_t.rds")
penda_res_3v1n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_3v1_n.rds")
penda_res_3v2c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_3v2_c_t.rds")
penda_res_3v2n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_3v2_n.rds")

penda_res_1v1c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v1_c_t.rds")
penda_res_1v1n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v1_n.rds")
penda_res_1v2c = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v2_c_t.rds")
penda_res_1v2n= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_1v2_n.rds")

# penda_res_2v1c_50 = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v1_c_t_50.rds")
# penda_res_2v1n_50= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v1_n_50.rds")
# penda_res_2v2c_50 = readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v2_c_t_50.rds")
# penda_res_2v2n_50= readRDS("~/projects/pipeline_deconv_analysis/results/penda/ct_n_cancer/res_2v2_n_50.rds")

penda_1v1c = abs(penda_res_1v1c$up_genes - penda_res_1v1c$down_genes)
penda_1v1n  = abs(penda_res_1v1n$up_genes - penda_res_1v1n$down_genes)

penda_1v2c = abs(penda_res_1v2c$up_genes - penda_res_1v2c$down_genes)
penda_1v2n  = abs(penda_res_1v2n$up_genes - penda_res_1v2n$down_genes)

penda_2v1c = abs(penda_res_2v1c$up_genes - penda_res_2v1c$down_genes)
penda_2v1n  = abs(penda_res_2v1n$up_genes - penda_res_2v1n$down_genes)

penda_2v2c = abs(penda_res_2v2c$up_genes - penda_res_2v2c$down_genes)
penda_2v2n  = abs(penda_res_2v2n$up_genes - penda_res_2v2n$down_genes)

penda_3v1c = abs(penda_res_3v1c$up_genes - penda_res_3v1c$down_genes)
penda_3v1n  = abs(penda_res_3v1n$up_genes - penda_res_3v1n$down_genes)

penda_3v2c = abs(penda_res_3v2c$up_genes - penda_res_3v2c$down_genes)
penda_3v2n  = abs(penda_res_3v2n$up_genes - penda_res_3v2n$down_genes)

pre_treat = function(penda_res){
  g_egaux = which(apply(penda_res, 1, function(g) {
    length(table(g)) == 1
  }))
  penda_res = penda_res[-g_egaux, ]

  g_sup = which(apply(penda_res, 1, function(g) {
    table(g)[1] > 5 & table(g)[2] > 5
  }))
  penda_res = penda_res[g_sup, ]
}
penda_1v1c = pre_treat(penda_1v1c)
penda_1v1n = pre_treat(penda_1v1n)

penda_1v2c = pre_treat(penda_1v2c)
penda_1v2n= pre_treat(penda_1v2n)

penda_2v1c = pre_treat(penda_2v1c)
penda_2v1n = pre_treat(penda_2v1n)

penda_2v2c = pre_treat(penda_2v2c)
penda_2v2n = pre_treat(penda_2v2n)

penda_3v1c = pre_treat(penda_3v1c)
penda_3v1n = pre_treat(penda_3v1n)

penda_3v2c = pre_treat(penda_3v2c)
penda_3v2n = pre_treat(penda_3v2n)


dim(penda_1v1c)
dim(penda_1v1n)
dim(penda_1v2c)
dim(penda_1v2n)

dim(penda_2v1c)
dim(penda_2v1n)
dim(penda_2v2c)
dim(penda_2v2n)

dim(penda_3v1c)
dim(penda_3v1n)
dim(penda_3v2c)
dim(penda_3v2n)


genes_c_f_1v1 = genes_c[(genes_c %in% rownames(penda_1v1c))]
length(genes_c_f_1v1)
genes_c_f_1v2 = genes_c[(genes_c %in% rownames(penda_1v2c))]
length(genes_c_f_1v2)

genes_c_f_2v1 = genes_c[(genes_c %in% rownames(penda_2v1c))]
length(genes_c_f_2v1)
genes_c_f_2v2 = genes_c[(genes_c %in% rownames(penda_2v2c))]
length(genes_c_f_2v2)

genes_c_f_3v1 = genes_c[(genes_c %in% rownames(penda_3v1c))]
length(genes_c_f_3v1)
genes_c_f_3v2 = genes_c[(genes_c %in% rownames(penda_3v2c))]
length(genes_c_f_3v2)


genes_n_f_1v1 = genes_n[(genes_n %in% rownames(penda_1v1n))]
length(genes_n_f_1v1)
genes_n_f_1v2 = genes_n[(genes_n %in% rownames(penda_1v2n))]
length(genes_n_f_1v2)

genes_n_f_2v1 = genes_n[(genes_n %in% rownames(penda_2v1n))]
length(genes_n_f_2v1)
genes_n_f_2v2 = genes_n[(genes_n %in% rownames(penda_2v2n))]
length(genes_n_f_2v2)

genes_n_f_3v1 = genes_n[(genes_n %in% rownames(penda_3v1n))]
length(genes_n_f_3v1)
genes_n_f_3v2 = genes_n[(genes_n %in% rownames(penda_3v2n))]
length(genes_n_f_3v2)

```


#Test par type cellulaire 

##Calculs

### P valeurs et distances

On étudie la distance entre deux groupes, qui contiennent les gènes dérégulés VS les gènes inchangés, dans 100 individus chacun minimum.

On passe chaque gène de Penda un par un. Pour chaque type cellulaire, on calcule la distance des deux groupes. On obtient pour chacun des trois paramètres une matrice de distances de taille g*k avec pour chaque gène et pour chaque type cellulaire les valeurs : 

* Distance de kantorovich
* -log10(p-valeur) du test de Student
* Distance et -log10(p-valeur) du test de Kolmogorov-Smirnov
* cv de chaque groupe

```{r function_calc_dist, echo = FALSE }

calc_dist = function(penda_res){
  options(warn = -1)
  res_dereg = c()

  #Pour chaque gène
  for(g in rownames(penda_res)){
  gene = penda_res[g, ]
  
  p_dereg = which(gene != 0)
  p_zero = which(gene == 0)
  
  if(length(p_dereg) != 0 & length(p_zero) != 0){
    #Pour chaque type cellulaire
    for(t in 1:nrow(A_60p)){
      #On fait les deux groupes
      x = A_60p[t, p_dereg]
      y = A_60p[t, p_zero]
      
      kanto_dist = kantorovich(x, y)
      student = -log10(t.test(x, y)$p.value)
      ks = ks.test(x, y)
      cvx = sd(x) / mean(x)
      cvy = sd(y) / mean(y)
        
      res_dereg = rbind(res_dereg, c(g, length(p_dereg), length(p_zero), t, kanto_dist, student, ks$statistic, -log10(ks$p.value), cvx, cvy))
      }
    }
  }
  options(warn = 0)
    colnames(res_dereg) = c("Gene", "nb_dereg", "nb_zero", "type", "kanto", "student", "ks d", "ks pvalue", "cvx", "cvy")
    return(res_dereg)
}
```


```{r, echo = FALSE }

res_dereg_1v1_c = calc_dist(penda_1v1c)
print("Dim des matrices de résultat")
dim(res_dereg_1v1_c)

res_dereg_1v1_n = calc_dist(penda_1v1n)
print("Dim des matrices de résultat")
dim(res_dereg_1v1_n)

res_dereg_1v2_c = calc_dist(penda_1v2c)
print("Dim des matrices de résultat")
dim(res_dereg_1v2_c)

res_dereg_1v2_n = calc_dist(penda_1v2n)
print("Dim des matrices de résultat")
dim(res_dereg_1v2_n)


res_dereg_2v1_c = calc_dist(penda_2v1c)
print("Dim des matrices de résultat")
dim(res_dereg_2v1_c)

res_dereg_2v1_n = calc_dist(penda_2v1n)
print("Dim des matrices de résultat")
dim(res_dereg_2v1_n)

res_dereg_2v2_c = calc_dist(penda_2v2c)
print("Dim des matrices de résultat")
dim(res_dereg_2v2_c)

res_dereg_2v2_n = calc_dist(penda_2v2n)
print("Dim des matrices de résultat")
dim(res_dereg_2v2_n)


res_dereg_3v1_c = calc_dist(penda_3v1c)
print("Dim des matrices de résultat")
dim(res_dereg_3v1_c)

res_dereg_3v1_n = calc_dist(penda_3v1n)
print("Dim des matrices de résultat")
dim(res_dereg_3v1_n)

res_dereg_3v2_c = calc_dist(penda_3v2c)
print("Dim des matrices de résultat")
dim(res_dereg_3v2_c)

res_dereg_3v2_n = calc_dist(penda_3v2n)
print("Dim des matrices de résultat")
dim(res_dereg_3v2_n)


```


###Corrélation avec l'expression

```{r, echo = FALSE }
cor_T60_c = c()
cor_T60_n = c()
options(warn = -1)
for(g in rownames(T_60tum_c$T)){
  for(t in 1:nrow(A_60p)){
    #On fait les deux groupes
    c = cor(T_60tum_c$T[g, ], A_60p[t, ])
    cor_T60_c = rbind(cor_T60_c, c(g, t, c))
    c = cor(T_60tum_n$T[g, ], A_60p[t, ])
    cor_T60_n = rbind(cor_T60_n, c(g, t, c))
  }
}
options(warn = 0)
```


##Représentation

Si on représente graphiquement ces matrices, on voit nettement les gènes qui donnent une plus grande distance entre les deux groupes pour chaque type : ces gènes doivent donc être propre au type cellulaire.

Si pour un gène et un type cellulaire il y a une grande distance entre le groupe qui ne l'exprime pas et le groupe qui le surexprime, ça signifie que ce gène est probablement un marqueur de ce type cellulaire.

Kanto : 75% des distances < 0.06

Student : 75% des -log10(pvalue) < 0.8

Ks : 75% des distances < 0.30

```{r plot_deregul, echo = F}
as_df_res = function(res_dereg){
  df =  data.frame(genes = res_dereg[, 1],
                kanto = as.numeric(res_dereg[, 5]),
                type =  factor(res_dereg[, 4]),
                student = as.numeric(res_dereg[, 6]),
                ks = as.numeric(res_dereg[, 8]),  stringsAsFactors = F)
  return(df)
}

df_1v1_c = as_df_res(res_dereg_1v1_c)
df_1v1_n = as_df_res(res_dereg_1v1_n)

df_1v2_c = as_df_res(res_dereg_1v2_c)
df_1v2_n = as_df_res(res_dereg_1v2_n)

df_2v1_c = as_df_res(res_dereg_2v1_c)
df_2v1_n = as_df_res(res_dereg_2v1_n)

df_2v2_c = as_df_res(res_dereg_2v2_c)
df_2v2_n = as_df_res(res_dereg_2v2_n)

df_3v1_c = as_df_res(res_dereg_3v1_c)
df_3v1_n = as_df_res(res_dereg_3v1_n)

df_3v2_c = as_df_res(res_dereg_3v2_c)
df_3v2_n = as_df_res(res_dereg_3v2_n)

```

###P-valeurs et courbes ROC

```{r function_compute, echo = F}
compute_1_res = function(values, genes, genes_fibro, genes_immune, pval){
  names(values) = stringr::str_c(genes, rep(1:4))
  values = values[!is.na(values)]

  genes_dereg = c(values[stringr::str_c(genes_fibro, rep(2))], values[stringr::str_c(genes_immune, rep(3))])
  genes_dereg = genes_dereg[!is.na(genes_dereg)]
  
  TP = sum(genes_dereg > -log10(pval))
  
  FN = length(genes_dereg) - TP
  
  FP =  sum(values > -log10(pval)) - TP
  
  TN =  length(values) - TP - FN - FP
  
  TPR  = TP / (TP + FN)
  FPR = FP / (TN + FP)
  return(c(TP, FP, TN, FN, FPR, TPR))
}
```

```{r function_plot, echo = F}
pvalues = c(0, 0.00005, 0.0001, 0.0005, 0.001, 0.0025, 0.005, 0.0075, 0.01, 0.02, 0.03, 0.04, 0.05, 0.1, 0.15, 0.2, 0.25,  0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1)

plot_res = function(genes_f, T, df_res, cor_T, titre_graph){
  g_fibro = unique(genes_f[genes_f%in%rownames(T$T)[T$g_fibro]])
  g_immune = unique(genes_f[genes_f%in%rownames(T$T)[T$g_immune]])
  res_ks = sapply(pvalues, function(x){
    compute_1_res(df_res$ks, df_res$genes, g_fibro, g_immune, x)
    })
  res_st = sapply(pvalues, function(x){
    compute_1_res(df_res$student, df_res$genes, g_fibro, g_immune, x)
    })
  res_kanto = sapply(pvalues, function(x){
    compute_1_res(df_res$kanto, df_res$genes, g_fibro, g_immune, x)
    })
  res_cor = sapply(pvalues, function(x){
    compute_1_res(abs(as.numeric(cor_T[, 3])), cor_T[, 1], rownames(T$T)[T$g_fibro], rownames(T$T)[T$g_immune], x)})
  df = data.frame(pval = as.factor(rep(pvalues)),
                FPR = c(res_ks[5, ], res_st[5, ], res_kanto[5, ], res_cor[5, ]),
                TPR = c(res_ks[6, ], res_st[6, ], res_kanto[6, ], res_cor[6, ]),
                metrique = rep(c("ks", "student", "kanto", "correlation"), each = length(pvalues)))

  plot = ggplot(df, aes(x = FPR, y = TPR, color = metrique, group = metrique)) +
  geom_point() + 
  geom_line() + 
  theme_minimal()+
  labs(title = titre_graph) 

  return(plot)
}

```

```{r fig 1v, echo = F}
plot_res(genes_c_f_1v1, T_60tum_c, df_1v1_c, cor_T60_c, "T tum ref VS T epi ref c" )
plot_res(genes_n_f_1v1, T_60tum_n, df_1v1_n, cor_T60_n, "T tum ref VS T epi ref n" )

plot_res(genes_c_f_1v2, T_60tum_c, df_1v2_c, cor_T60_c, "T tum ref VS T epi deconv c" )
plot_res(genes_n_f_1v2, T_60tum_n, df_1v2_n, cor_T60_n, "T tum ref VS T epi deconv n" )
```

```{r fig_2v, echo = F}
plot_res(genes_c_f_2v1, T_60tum_c, df_2v1_c, cor_T60_c, "D cancer VS T epi ref c" )
plot_res(genes_n_f_2v1, T_60tum_n, df_2v1_n, cor_T60_n, "D cancer VS T epi ref n" )

plot_res(genes_c_f_2v2, T_60tum_c, df_2v2_c, cor_T60_c, "D cancer VS T epi deconv c" )
plot_res(genes_n_f_2v2, T_60tum_n, df_2v2_n, cor_T60_n, "D cancer VS T epi deconv n" )
```

```{r fig_3v, echo = F}
plot_res(genes_c_f_3v1, T_60tum_c, df_3v1_c, cor_T60_c, "D cancer ssnorm VS T epi ref c" )
plot_res(genes_n_f_3v1, T_60tum_n, df_3v1_n, cor_T60_n, "D cancer ssnorm VS T epi ref n" )

plot_res(genes_c_f_3v2, T_60tum_c, df_3v2_c, cor_T60_c, "D cancer ssnorm VS T epi deconv c" )
plot_res(genes_n_f_3v2, T_60tum_n, df_3v2_n, cor_T60_n, "D cancer ssnorm VS T epi deconv n" )
```