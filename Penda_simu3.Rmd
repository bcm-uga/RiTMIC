---
title: "Penda test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=TRUE}
T_ctrl = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_rna.rds")
T_60tum_n = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_n.rds")
T_60tum_c_t = readRDS("~/projects/pipeline_deconv_analysis/data/T/T_60_tum_rna_c_t.rds")

T_80p_n = readRDS("~/projects/pipeline_deconv_analysis/results/deconv/EDec2_80p_n.rds")
T_80p_c_t = readRDS("~/projects/pipeline_deconv_analysis/results/deconv/EDec2_80p_c_t.rds" )
```

```{r results="verbatim"}
data_ctrl = T_ctrl[, 1]
head(data_ctrl)
length(data_ctrl)

dim(T_60tum_n$T)
```


# Method

`penda` performs a 3-steps analysis: 

1. Data filtering and creation of the dataset

2. Gene ranking

3. Differential expression testing

This is a tutorial describing how to use `penda` package.

## Data filtering

Comme on a un seul contrôle, on trie juste par la médiane sans appliquer de tri

```{r label="penda::make_dataset"}
make_dataset_1ctrl = function(controls, data_case){
    resume = c(length(controls), 1, ncol(data_case))
    names(resume) = c("init_nb_genes", "init_nb_ctrls", "init_nb_cases")
    median_gene = sort(controls)
    controls = controls[names(median_gene)]
    data_case = data_case[names(median_gene), ]
    return(list(data_ctrl = controls, data_case = data_case, 
        info = round(resume, 2)))
}

Penda_dataset_60n = make_dataset_1ctrl(data_ctrl, T_60tum_n$T)
Penda_dataset_60c_t = make_dataset_1ctrl(data_ctrl, T_60tum_c_t$T)
```

## Gene ranking

```{r, results="verbatim"}
list_LH_1ctrl = function (controls, threshold, s_max = 100) {
    controls = cbind(controls, controls)
    LH = penda::compute_LH_cpp(controls, threshold, s_max)
    genes_L = unlist(LH$L)
    rownames(genes_L) = LH$n
    genes_H = unlist(LH$H)
    rownames(genes_H) = LH$n
    gc()
    return(list(L = genes_L, H = genes_H))
}

L_H_list_500 = list_LH_1ctrl(Penda_dataset_60n$data_ctrl, threshold = 0.99, s_max = 500)

```

## Differential expression testing

Then, we used  `penda_test` to make the differential expresion test. This function analyse case samples one by one and compare their genes rank to the L_H_list.

Results are in the form of two matrix `$down_genes` and `$up_genes`, with for each case (column), TRUE if the gene (line) is deregulated (resp. down-regulated or up-regulated). 

#Fonctions de test pour un seul contrôle (sans quantile)

```{r }
regulation_test_1p = function(gene, L_H_list, sample, threshold){
  #If the gene is NA in the sample, we can't compute the dysregulation.
  if (is.na(sample[gene])){
    return(0)
  } else {
    #Compute the quantile for the quantile method, if L or H does not exist.
    changement = numeric()
    L = sample[L_H_list$L[gene, ]]
    L = L[!is.na(L)]
    H = sample[L_H_list$H[gene, ]]
    H = H[!is.na(H)]

    Lh = sum(L > sample[gene])
    Hl = sum(H < sample[gene])
    Ll = length(L) - Lh
    Hh = length(H) - Hl

    #If exists both lower and higher expressed lists,
    if (length(L) != 0 & length(H) != 0){
      if ((Hl / length(H) < threshold) & ((Lh / length(L) < threshold))){
        changement = 0
      } else if ((Ll + Hl) < length(L)){
        changement = -1
      } else {
        changement = 1
      }
      return(changement)
    }
    #If exists only the higher expressed list,
    else if (length(L) == 0 & length(H) != 0){
      if (Hl / length(H) >= threshold){
        changement = 1
      } else {
        changement = 0
      }
      return(changement)
    }
    #If exists only the lower expressed list,
    else if (length(L) != 0 & length(H) == 0){
      if (Lh / length(L) >= threshold){
        changement = -1
      } else {
        changement = 0
      }
      return(changement)
    }
    #If there is no expression list,
    else{
      return(0)
    }
  }
}



sample_test_1p = function (sample, iterations, threshold){

  l1 = rep(FALSE, length(sample))
  l1n1 = rep(FALSE, length(sample))
  l1n2 = rep(FALSE, length(sample))
  print("Begining of iterations")

  #For each iteration
  for (i in seq_len(iterations)){
    print(paste0("Iteration ", i))
    #Genes dysregulated at the previous iteration are removed of L_H.
    L_H_list_tmp = L_H_list
    id_l1 = which(l1 != 0)
    L_H_list_tmp$L = apply(L_H_list_tmp$L, 2, function(g){
      g[g %in% id_l1] = 0
      return(g)
    })
    L_H_list_tmp$H = apply(L_H_list_tmp$H, 2, function(g){
      g[g %in% id_l1] = 0
      return(g)
    })

    #The dysregulation of each gene is compute.
    l1 = sapply(names(sample), function(gene){
      expression = regulation_test_1p(gene, L_H_list_tmp, sample, threshold)
      return(expression)
    })

    #Stabilization is checked.
    if((sum(l1 == l1n1) == length(l1)) | (sum(l1 == l1n2) == length(l1))){
      print ("Stabilization of the dysregulated genes list.")
      break
    } else if (i == iterations) {
      print ("Maximum iterations without stabilization.")
    } else {
      l1n2 = l1n1
      l1n1 = l1
    }
  }
  U_genes = (l1 == 1 | l1n1 == 1)
  D_genes = (l1 == -1 | l1n1 == -1)
  return(list(D = D_genes, U = U_genes))
  gc()
}

penda_test_1p = function(samples, controls, iterations, L_H_list, threshold){

  L_H_list <<- L_H_list
  if (is.null(dim(samples)[2])){
    print("Compute DE list for one sample")
    res = sample_test_1p(sample = samples,
                         threshold = threshold,
                         iterations =  iterations)
    down_genes = res$D
    up_genes = res$U
  } else if (dim(samples)[2] > 1){
    print(paste0("Compute DE list for ", dim(samples)[2], " samples"))
    nbpatient = 0
    res = apply(samples, 2, function(s){
      nbpatient <<- nbpatient + 1
      print(paste0("Patient ", nbpatient, "/", dim(samples)[2]))
      sample_test_1p(s, threshold = threshold, iterations =  iterations)
    })
    down_genes = sapply(res, "[[", "D")
    up_genes = sapply(res, "[[", "U")
  } else {
    print("Error, samples should correspond to a matrix or a vector")
    down_genes = NULL
    up_genes = NULL
  }
  return(list(down_genes = down_genes, up_genes = up_genes))
}



```

```{r, results="verbatim"}
controls =  cbind(Penda_dataset_60n$data_ctrl, Penda_dataset_60n$data_ctrl)

test_res_n = penda_test_1p(samples = Penda_dataset_60n$data_case,
                      controls = controls,
                      L_H_list = L_H_list_500,
                      threshold = 0.97,
                      iterations =  30)

colSums(test_res_n$down_genes)
colSums(test_res_n$up_genes)

saveRDS(test_res_n, "~/projects/pipeline_deconv_analysis/results/penda/res_60n.rds")

test_res_c_t = penda_test_1p(samples = Penda_dataset_60c_t$data_case,
                      controls = controls,
                      L_H_list = L_H_list_500,
                      threshold = 0.97,
                      iterations =  30)

colSums(test_res_c_t$down_genes)
colSums(test_res_c_t$up_genes)

saveRDS(test_res_c_t, "~/projects/pipeline_deconv_analysis/results/penda/res_60c_t.rds")

```
